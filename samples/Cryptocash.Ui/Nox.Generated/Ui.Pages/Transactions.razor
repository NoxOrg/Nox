@using Nox.Ui.Blazor.Lib.Components.Generic
@using Nox.Ui.Blazor.Lib.Services
@using Nox.Ui.Blazor.Lib.Resources
@using Cryptocash.Ui.Forms.Add
@using Cryptocash.Ui.Forms.Edit
@using Cryptocash.Ui.DataGrid
@using Cryptocash.Ui.Models
@using NoxResources = Nox.Ui.Blazor.Lib.Resources.Resources
@using Cryptocash.Ui.Services

@namespace Cryptocash.Ui.Pages

@page "/Transactions"

@inject ApplicationState AppState
@{
    AppState.PageTitle = "Transactions";
}
@inject IDialogService DialogService

@inject ITransactionsService TransactionsService

<MudText>Transactions</MudText>

<MudGrid Spacing="0">
    <MudItem xs="12">
        <MudText>Search section</MudText>
    </MudItem>
    <MudItem xs="12" Style="margin:15px 0px 15px 0px;text-align:right;">
        <Actions OnClick="ShowAddDialog" Title="@NoxResources.Add.ToUpper()" StartIcon="@Icons.Material.Filled.Add" />
    </MudItem>
    <AddTransactionForm @bind-IsVisible="showAddDialog" OnSubmit="AddTransactionSubmit" OnCancel="HideAddDialog" />
    <EditTransactionForm @bind-IsVisible="showEditDialog" OnSubmit="EditTransactionSubmit" OnCancel="HideEditDialog" Transaction="selectedEntity" />
    <MudItem xs="12">
        <TransactionsDataGrid @ref="referencedDataGrid" OnSelectionChanged="@(e=>ShowEditDialog(e))" OnDeleteChanged="@(e=>ShowDeleteConfirmation(e))" />
    </MudItem>
</MudGrid>
<MudDialog @bind-IsVisible="showDeleteDialog" Options="ConfirmationDialogOptions">
        <TitleContent>
            <MudGrid>
                <MudItem Style="background-color:red;margin-top:5px;" xs="12">
                    <MudText Typo="Typo.h6" Style="color:white;">@string.Format(NoxResources.DeleteEntity, "Transaction")</MudText>
                </MudItem>
            </MudGrid>
        </TitleContent>
        <DialogContent>
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6">@string.Format(NoxResources.DeleteConfirmation, "Transaction")</MudText>
                </MudItem>
            </MudGrid>
            @if (HasDeleteError) {
            <ErrorSummary />
            <MudText Color="Color.Error">ERROR</MudText>
        }
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="@HideDeleteConfirmation"
                       Variant="Variant.Outlined"
                       Color="Color.Error"
                       Style="Margin:15px;">
                @NoxResources.Cancel.ToUpper()
            </MudButton>
            <MudButton OnClick="@DeleteTransactionSubmit"
                       Variant="Variant.Filled"
                       Color="Color.Error"
                       Style="Margin:15px;"
                       Disabled="@IsDeleteLoading">
                <MudText>@NoxResources.Delete.ToUpper()</MudText>
                @if (IsDeleteLoading)
                {
                    <MudProgressCircular Color="Color.Default" Indeterminate="true" Size="Size.Small" />
                }
            </MudButton>
        </DialogActions>
    </MudDialog>

@code{

private TransactionsDataGrid? referencedDataGrid;

#region ADD
    private bool showAddDialog = false;

    private void ShowAddDialog()
    {
        showAddDialog = true;
    }

    private void HideAddDialog()
    {
        showAddDialog = false;
    }

    private void AddTransactionSubmit()
    {
        showAddDialog = false;        
        referencedDataGrid?.RefreshDataGrid();
    }
#endregion ADD
#region EDIT
    private bool showEditDialog = false;   
    
    [Parameter]
    public TransactionModel? selectedEntity { get; set; }   

    private void ShowEditDialog(TransactionModel? currentSelected)
    {
        selectedEntity = currentSelected;
        showEditDialog = true;
    }

    private void HideEditDialog()
    {
        showEditDialog = false;
    }

    private void EditTransactionSubmit()
    {
        showEditDialog = false;    
        selectedEntity = null;
        referencedDataGrid?.RefreshDataGrid();        
    }
#endregion EDIT
#region DELETE
    private bool showDeleteDialog = false; 
    
    private bool IsDeleteLoading = false;

    private bool HasDeleteError = false;
    
    [Parameter]
    public TransactionModel? deleteEntity { get; set; }   

    public DialogOptions ConfirmationDialogOptions { get; set; } = new()
    {
        ClassBackground = "dialog-blur-class",
        DisableBackdropClick = true,
        Position = DialogPosition.TopCenter,
        MaxWidth = MaxWidth.Medium
    };

    private void ShowDeleteConfirmation(TransactionModel? currentSelected)
    {
        deleteEntity = currentSelected;
        showDeleteDialog = true;
    }

    private void HideDeleteConfirmation()
    {
        showDeleteDialog = false;
    }

    private async Task DeleteTransactionSubmit()
    {
        try
        {
            IsDeleteLoading = true;

            if (deleteEntity != null)
            {
                await TransactionsService.DeleteAsync(deleteEntity);
            }
            else
            {
                HasDeleteError = true;
            }
        }
        catch
        {
            HasDeleteError = true;
        }
        finally
        {
            IsDeleteLoading = false;
            showDeleteDialog = false;    
            deleteEntity = null;
            referencedDataGrid?.RefreshDataGrid(); 
        }               
    }
#endregion DELETE
}